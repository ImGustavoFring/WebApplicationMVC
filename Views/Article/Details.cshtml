@model WebApplicationMVC.Models.Article
@using System.Security.Claims;
@{
    ViewData["Title"] = "Детали статьи";
    Layout = "_MainLayout";
}

<div class="container mt-5" style="margin-top: 100px; margin-bottom: 100px;">
    <div class="card">
        <div class="card-header">
            <h2>@Model.Title</h2>
            <p><strong>Автор:</strong> @Model.User?.Username</p>
            <p><strong>Дата создания:</strong> @Model.Createdat.ToString("yyyy-MM-dd HH:mm")</p>
            @if (Model.Updatedat.HasValue)
            {
                <p><strong>Последнее обновление:</strong> @Model.Updatedat.Value.ToString("yyyy-MM-dd HH:mm")</p>
            }
        </div>
        <div class="card-body">
            <p><strong>Содержание:</strong> @Model.Content</p>

            <p><strong>Видимость:</strong> @Model.Visibility?.Name</p>

            <p><strong>Теги:</strong></p>
            <ul>
                @foreach (var tag in Model.Tags.ToList())
                {
                    <li>@tag.Name</li>
                }
            </ul>

            <p><strong>Количество просмотров:</strong> @(Model.Views?.Count ?? 0)</p>

            @if (Model.Ratings?.Any() == true)
            {
                <p><strong>Средняя оценка:</strong> @(Model.Ratings.Average(r => r.Value).ToString("F1"))</p>
            }
            else
            {
                <p><strong>Средняя оценка:</strong> Нет оценок</p>
            }

            <h3>Комментарии</h3>
            <div>
                @foreach (var comment in Model.Comments.OrderBy(c => c.Createdat))
                {
                    <div class="border p-3 mb-3">
                        <p><strong>@comment.User?.Username</strong> (Дата: @comment.Createdat.ToString("yyyy-MM-dd HH:mm"))</p>
                        <p>@comment.Content</p>
                        @if (comment.Userid == int.Parse(User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier)))
                        {
                            <form asp-controller="Comment" asp-action="Delete" method="post">
                                <input type="hidden" name="articleId" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                            </form>

                        }
                    </div>
                }

                @if (User.Identity.IsAuthenticated)
                {
                    var userComment = Model.Comments.FirstOrDefault(c => c.Userid == int.Parse(User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier)));

                    if (userComment == null)
                    {
                        <h4>Добавить комментарий</h4>
                        <form method="post" asp-controller="Comment" asp-action="Add" asp-route-articleId="@Model.Id">
                            @Html.AntiForgeryToken()
                            <textarea name="content" class="form-control" placeholder="Ваш комментарий" required></textarea>
                            <button type="submit" class="btn btn-secondary mt-3">Отправить</button>
                        </form>




                    }
                    else
                    {
                        <p><strong>Вы уже оставили комментарий к этой статье.</strong></p>
                    }
                }
            </div>
        </div>
        <div class="card-footer">
            <a href="@Url.Action("Edit", "Article", new { id = Model.Id })" class="btn btn-secondary">Редактировать</a>
            <a href="@Url.Action("Articles", "Article")" class="btn btn-secondary">Назад</a>
        </div>
    </div>
</div>
